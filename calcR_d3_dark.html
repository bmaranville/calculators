<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Reflectivity and wavefunction for a slab profile</title>
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />
    <link rel="stylesheet" href="css/layout-default-latest.css" />
    <link rel="stylesheet" type="text/css" href="css/calcR.css" />
    <!-- Reference the theme's stylesheet on the Google CDN -->
        <link href="//ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/start/jquery-ui.css"
            type="text/css" rel="Stylesheet" />
<!-- Reference jQuery and jQuery UI from the CDN. Remember
           that the order of these two elements is important -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.2/jquery-ui.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="js/jquery.layout-latest.js"></script>
    
    <script type="text/javascript" src="js/complex.js"></script>
    <script type="text/javascript" src="js/wavefunction.js"></script>
    <script type="text/javascript" src="js/generate_slab_script.js"></script>
    
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
    <script src="//ncnr.nist.gov/instruments/magik/d3-science/lib/jquery-extend.js" charset="utf-8"></script>
    <script src="//ncnr.nist.gov/instruments/magik/d3-science/lib/xy-chart.js" charset="utf-8"></script>
    <script src="//ncnr.nist.gov/instruments/magik/d3-science/lib/profile-interactor.js"></script>
    <script src="//ncnr.nist.gov/instruments/magik/d3-science/lib/monotonic-function-interactor.js"></script>
    
    
    
    <script src="js/calcR_d3_app.js"></script>
   
<script type="text/javascript">
    var THETA_M = Math.PI * 3.0 / 2.0; // 270 degrees by default
    var AGUIDE = 270;
    
    

    var app_options = {
      initial_sld: [
        {thickness: 0, sld: 2.069, mu: 0, roughness: 10},
        {thickness: 1250, sld: 4, mu: 0, roughness: 10},
        {thickness: 0, sld: 0.0, mu: 0, roughness: 0}    
      ],
      to_fit: [
        {roughness: true},
        {sld: true, thickness: true, roughness: true},
        {}
      ],          
      plot_choices: {
        'reflectivity':   {data: 'xy', xlabel: 'Q (Å⁻¹)', ylabel: 'R (I/I₀)', title:'Reflectivity R=|Ψ←(z=-∞)|²'},
        'phase':          {data: 'phase', xlabel: 'Q (Å⁻¹)', ylabel: 'phase (radians)', title: 'Phase of r in complex plane (r = Ψ←)'},
      },
      sldplot_series_opts: [
        {label: "SLDₙ x10⁻⁶", id: "sld", color: "DodgerBlue", color1: "DodgerBlue"},
        {label: "iSLDₙ x10⁻⁶", id: "mu", color: "LightCoral", color1: "LightCoral"},
      ],
      worker_script: "js/calc_r.js",
      series_lookup: {"unpolarized": 1},
      reflplot_series_opts: [
        {label: "theory", show_points: false},
        {label: "data", show_points: true, show_line: false}
      ],
      constraints: [
        function(p, d, i) {p[0].thickness = 0},
        function(p, d, i) {p.slice(-1)[0].mu = 0},
        function(p, d, i) {p.slice(-1)[0].thickness = 0},
        function(p, d, i) {p[i].thickness = Math.max(p[i].thickness, 0)}
      ],
      east_size: 450
    };
    window.onload = function() {        
        $("#AGUIDE_label").css("display", "none");
    }
    var Module = Module || {};
    Module['memoryInitializerPrefixURL'] = 'js/refl/';
    Module.postRun = Module.postRun || [];
    Module.postRun.push(function() { app_init(app_options); $("#AGUIDE_label").css("display", "none"); });
    
    /*
    var sld_to_params = function() {
        var sld = app_options.initial_sld.slice().reverse();
        var to_fit = app_options.to_fit.reverse();
        var layers = sld.length;
        var c = [];
        var s = [];
        var bndu = [];
        var bndl = [];
        
        var columns = ["thickness", "roughness", "sld", "mu"];
        var scales = [10, 0.1, 0.1, 0.1];
        
        columns.forEach(function(col, ci) {
            c = c.concat(sld.map(l=>l[col]));
            s = s.concat(sld.map(l=>scales[ci]));
            bndl = bndl.concat(sld.map((l,i)=> (to_fit[i] && to_fit[i][col]) ? -Infinity : l[col]));
            bndu = bndu.concat(sld.map((l,i)=> (to_fit[i] && to_fit[i][col]) ? +Infinity : l[col]));
        })
        
        console.log({c: c, s: s, bndl: bndl, bndu: bndu});
        return {c: c, s: s, bndl: bndl, bndu: bndu}
    }
    
    var params_to_sld = function(params) {}
        
    
    var fit = function() {
        var params = sld_to_params();
        var xs = JSON.stringify(app_options.data.kz_list); // qz to kz
        var ys = JSON.stringify(app_options.data.R_list);
        var ws = JSON.stringify(app_options.data.dR_list.map(dy=>1.0/dy));
        var cs = JSON.stringify(params.c);
        var ss = JSON.stringify(params.s);
        
        var lower_bound = JSON.stringify(params.bndl).replace(/null/g, "-Inf");
        var upper_bound = JSON.stringify(params.bndu).replace(/null/g, "+Inf");
        console.log({xs: xs, ys: ys, ws: ws, cs: cs, ss: ss, upp: upper_bound, low: lower_bound});
        var str_result = Module.fit_refl(xs, ys, ws, cs, ss, lower_bound, upper_bound);
        var result = JSON.parse(str_result);
                
        console.log(result);
    }
    */
        
</script>   
<script src="js/refl/refl_fit.js"></script> 
</head>
<body bgcolor="#ffffcc"> 
    <div id="top_panel" class="ui-layout-north">
        Load (*.refl) datafile: <input type="file" multiple="false" id="datafile" name="datafile" />
        <a href="" id="pyscript_data_uri"></a>
        <input type="button" value="generate Refl1D script" id="scriptbutton">
        <input type="text" value="refl1d_script.py" width=20 id="scriptname">
    </div>
    <div id="centerpane" class="ui-layout-center">
        <div id='rplot'></div>
        <hr class="betweenplots">
        <div id='sldplot'></div>
    </div>
    <div id="right" class="ui-layout-east">
      <div id='plots_switcher'></div>
      <div id='q_controls'></div>
      <div id='sld_table' align='center'></div>
      <div id='file_controls' align='center'></div>
      <hr>
      <div id='fit_controls' align='center'>
        <span id='fit_log'></span>
      </div>
    </div>
    
    
    <div id="bottom_controls" align='center'>
        
    </div>
    <div id='footer'>
        <p><font size=2> <?php lastmod(); ?> </font></p>
    </div>
</body>
</html>

